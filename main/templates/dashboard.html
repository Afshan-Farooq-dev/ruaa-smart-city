{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard — Ruaa Smart City{% endblock %}

{% block content %}
<div class="app-wrapper">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <img src="{% static 'Ruaa2.png' %}" alt="Ruaa Logo" />
      </div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-section">
        <a href="{% url 'dashboard' %}" class="nav-link active">
          <i class="fas fa-home"></i>
          <span>Dashboard</span>
        </a>
        <a href="{% url 'traffic' %}" class="nav-link">
          <i class="fas fa-car"></i>
          <span>Traffic</span>
        </a>
        <a href="{% url 'weather' %}" class="nav-link">
          <i class="fas fa-cloud-sun"></i>
          <span>Weather</span>
        </a>
        <a href="{% url 'services' %}" class="nav-link">
          <i class="fas fa-hospital"></i>
          <span>Services</span>
        </a>
        <a href="{% url 'map' %}" class="nav-link">
          <i class="fas fa-map"></i>
          <span>City Map</span>
        </a>
        <a href="{% url 'settings' %}" class="nav-link" style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 0.5rem; padding-top: 1rem;">
          <i class="fas fa-cog"></i>
          <span>Email Settings</span>
        </a>
      </div>
    </nav>

    <div class="sidebar-footer">
      <div class="user-profile">
        <div class="user-avatar">
          <i class="fas fa-user"></i>
        </div>
        <div class="user-info">
          <div class="user-name">{{ user.username }}</div>
          <div class="user-role">Citizen</div>
        </div>
        <form method="post" action="{% url 'logout' %}" style="margin: 0;">
          {% csrf_token %}
          <button type="submit" class="logout-btn" title="Logout">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </form>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="page-title">
        <h2>AI Smart Assistant</h2>
        <div class="status-badge">
          <span class="status-dot"></span>
          <span>Online • Ready to assist you</span>
        </div>
      </div>
    </div>

    <!-- Content Area -->
    <div class="content-area">
      <!-- Chat Container -->
      <div class="chat-container">
        <div id="chat-messages" class="chat-messages">
          <!-- Welcome Message -->
          <div class="chat-message bot">
            <div class="message-avatar">
              <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
              <div class="chat-bubble">
                <p><strong>Hello! I'm Ruaa</strong>, your Smart City AI Assistant.</p>
                <p class="mt-2">I'm here to help you with:</p>
                <ul class="mt-2 space-y-1">
                  <li>Traffic updates and road conditions</li>
                  <li>Weather forecasts and conditions</li>
                  <li>Public services and facilities</li>
                  <li>Emergency contact numbers</li>
                </ul>
                <p class="mt-2 text-muted">What would you like to know?</p>
              </div>
              <div class="message-time">Just now</div>
            </div>
          </div>
        </div>

        <!-- Chat Input -->
        <div class="chat-input-area">
          <!-- Quick Suggestions -->
          <div class="quick-suggestions">
            <button onclick="quickAsk('What is the traffic status?')" class="suggestion-chip">
              Traffic Status
            </button>
            <button onclick="quickAsk('Tell me about the weather')" class="suggestion-chip">
              Weather
            </button>
            <button onclick="quickAsk('Where are the hospitals?')" class="suggestion-chip">
              Hospitals
            </button>
            <button onclick="quickAsk('What are emergency numbers?')" class="suggestion-chip">
              Emergency
            </button>
          </div>

          <!-- Input Box -->
          <div class="input-group">
            <input 
              type="text" 
              id="user-input" 
              class="chat-input"
              placeholder="Type your message here..."
            >
            <button id="send-btn" class="btn btn-primary">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const chatMessages = document.getElementById('chat-messages');
const userInput = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');

function getTimeStamp() {
  const now = new Date();
  return now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function addMessage(text, isUser = false) {
  const messageDiv = document.createElement('div');
  messageDiv.className = 'chat-message ' + (isUser ? 'user' : 'bot');
  
  if (isUser) {
    messageDiv.innerHTML = `
      <div class="message-content">
        <div class="chat-bubble">
          <p>${escapeHtml(text)}</p>
        </div>
        <div class="message-time">${getTimeStamp()}</div>
      </div>
      <div class="message-avatar">
        <i class="fas fa-user"></i>
      </div>
    `;
  } else {
    messageDiv.innerHTML = `
      <div class="message-avatar">
        <i class="fas fa-robot"></i>
      </div>
      <div class="message-content">
        <div class="chat-bubble">
          <p>${escapeHtml(text)}</p>
        </div>
        <div class="message-time">${getTimeStamp()}</div>
      </div>
    `;
  }
  
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showTypingIndicator() {
  const typingDiv = document.createElement('div');
  typingDiv.id = 'typing-indicator';
  typingDiv.className = 'chat-message bot';
  typingDiv.innerHTML = `
    <div class="message-avatar">
      <i class="fas fa-robot"></i>
    </div>
    <div class="message-content">
      <div class="typing-indicator">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  `;
  chatMessages.appendChild(typingDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideTypingIndicator() {
  const indicator = document.getElementById('typing-indicator');
  if (indicator) indicator.remove();
}

async function sendMessage() {
  const message = userInput.value.trim();
  if (!message) return;
  
  addMessage(message, true);
  userInput.value = '';
  sendBtn.disabled = true;
  sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  
  showTypingIndicator();
  
  try {
    const response = await fetch('{% url "chatbot" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ message: message })
    });
    
    const data = await response.json();
    
    hideTypingIndicator();
    
    if (data.response) {
      addMessage(data.response, false);
    } else if (data.error) {
      addMessage('Sorry, I encountered an error: ' + data.error, false);
    }
  } catch (error) {
    hideTypingIndicator();
    addMessage('Sorry, I could not process your request. Please try again.', false);
  } finally {
    sendBtn.disabled = false;
    sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
    userInput.focus();
  }
}

function quickAsk(question) {
  userInput.value = question;
  sendMessage();
}

sendBtn.addEventListener('click', sendMessage);
userInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    sendMessage();
  }
});

userInput.focus();
</script>
{% endblock %}
