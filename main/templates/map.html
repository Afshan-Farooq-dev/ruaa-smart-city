{% extends 'base.html' %}
{% load static %}

{% block title %}City Map — Ruaa Smart City{% endblock %}

{% block content %}
<div class="app-wrapper">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <img src="{% static 'Ruaa2.png' %}" alt="Ruaa Logo" />
      </div>
      <div class="sidebar-brand">
        <h1>Ruaa</h1>
        <p>Smart City</p>
      </div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-section">
        <a href="{% url 'dashboard' %}" class="nav-link">
          <i class="fas fa-home"></i>
          <span>Dashboard</span>
        </a>
        <a href="{% url 'traffic' %}" class="nav-link">
          <i class="fas fa-car"></i>
          <span>Traffic</span>
        </a>
        <a href="{% url 'weather' %}" class="nav-link">
          <i class="fas fa-cloud-sun"></i>
          <span>Weather</span>
        </a>
        <a href="{% url 'services' %}" class="nav-link">
          <i class="fas fa-hospital"></i>
          <span>Healthcare</span>
        </a>
        <a href="{% url 'tourism' %}" class="nav-link">
          <i class="fas fa-landmark"></i>
          <span>Tourism</span>
        </a>
        <a href="{% url 'transportation' %}" class="nav-link">
          <i class="fas fa-subway"></i>
          <span>Transportation</span>
        </a>
        <a href="{% url 'map' %}" class="nav-link active">
          <i class="fas fa-map"></i>
          <span>City Map</span>
        </a>
      </div>
    </nav>

    <div class="sidebar-footer">
      <div class="user-profile">
        <div class="user-avatar">
          <i class="fas fa-user"></i>
        </div>
        <div class="user-info">
          <div class="user-name">{{ user.username }}</div>
          <div class="user-role">Citizen</div>
        </div>
        <form method="post" action="{% url 'logout' %}" style="margin: 0;">
          {% csrf_token %}
          <button type="submit" class="logout-btn" title="Logout">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </form>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="page-title">
        <h2><i class="fas fa-map me-2" style="color: var(--brand-green);"></i>Saudi Arabia Traffic Map</h2>
        <p>Live traffic status across major cities • Synchronized with Traffic Page</p>
      </div>
    </div>

    <!-- Content Area -->
    <div class="content-area">
      <!-- Map Container -->
      <div id="map" style="width: 100%; height: 700px; border-radius: 16px; box-shadow: 0 12px 48px rgba(0,0,0,0.15); margin-bottom: 2rem;"></div>

      <!-- Cities Quick Reference -->
      <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1.5rem;">
        
        <!-- Riyadh -->
        <div style="background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); text-align: center; color: white;">
          <i class="fas fa-city" style="font-size: 2rem; margin-bottom: 0.75rem;"></i>
          <div style="font-weight: 700; font-size: 1.1rem;">Riyadh</div>
          <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.25rem;">الرياض</div>
        </div>

        <!-- Jeddah -->
        <div style="background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); text-align: center; color: white;">
          <i class="fas fa-water" style="font-size: 2rem; margin-bottom: 0.75rem;"></i>
          <div style="font-weight: 700; font-size: 1.1rem;">Jeddah</div>
          <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.25rem;">جدة</div>
        </div>

        <!-- Makkah -->
        <div style="background: linear-gradient(135deg, #92400E 0%, #78350F 100%); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(146, 64, 14, 0.3); text-align: center; color: white;">
          <i class="fas fa-mosque" style="font-size: 2rem; margin-bottom: 0.75rem;"></i>
          <div style="font-weight: 700; font-size: 1.1rem;">Makkah</div>
          <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.25rem;">مكة المكرمة</div>
        </div>

        <!-- Madinah -->
        <div style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); text-align: center; color: white;">
          <i class="fas fa-mosque" style="font-size: 2rem; margin-bottom: 0.75rem;"></i>
          <div style="font-weight: 700; font-size: 1.1rem;">Madinah</div>
          <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.25rem;">المدينة المنورة</div>
        </div>

        <!-- Dammam -->
        <div style="background: linear-gradient(135deg, #FBBF24 0%, #F59E0B 100%); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3); text-align: center; color: white;">
          <i class="fas fa-oil-can" style="font-size: 2rem; margin-bottom: 0.75rem;"></i>
          <div style="font-weight: 700; font-size: 1.1rem;">Dammam</div>
          <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.25rem;">الدمام</div>
        </div>

      </div>

      <!-- Interactive Legend -->
      <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-top: 2rem;">
        <h5 style="margin: 0 0 15px 0; font-weight: 700; color: #1F2937; font-size: 1rem;">
          <i class="fas fa-traffic-light" style="color: #3B82F6; margin-right: 8px;"></i>
          Traffic Status Legend
        </h5>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 40px; height: 4px; background: #10B981; border-radius: 2px;"></div>
            <span style="font-size: 0.9rem; color: #4B5563; font-weight: 500;">Clear Traffic</span>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 40px; height: 4px; background: #FBBF24; border-radius: 2px;"></div>
            <span style="font-size: 0.9rem; color: #4B5563; font-weight: 500;">Moderate Traffic</span>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 40px; height: 4px; background: #F97316; border-radius: 2px;"></div>
            <span style="font-size: 0.9rem; color: #4B5563; font-weight: 500;">Heavy Traffic</span>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 40px; height: 4px; background: #EF4444; border-radius: 2px;"></div>
            <span style="font-size: 0.9rem; color: #4B5563; font-weight: 500;">Road Closed</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
window.addEventListener('load', function() {
  setTimeout(function() {
    var mapEl = document.getElementById('map');
    
    if (!mapEl || typeof L === 'undefined') {
      console.error('Map element or Leaflet not found');
      return;
    }
    
    try {
      var map = L.map('map', {
        center: [23.8859, 45.0792],
        zoom: 6,
        zoomControl: false
      });
      
      L.control.zoom({
        position: 'topright'
      }).addTo(map);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 18
      }).addTo(map);
      
      var trafficData = {{ traffic_data_json|safe }};
      
      var cityData = {
        'Riyadh': { lat: 24.7136, lng: 46.6753, color: '#3B82F6', icon: 'fa-city' },
        'Jeddah': { lat: 21.5433, lng: 39.1727, color: '#EF4444', icon: 'fa-water' },
        'Makkah': { lat: 21.4225, lng: 39.8262, color: '#92400E', icon: 'fa-mosque' },
        'Madinah': { lat: 24.4672, lng: 39.5936, color: '#10B981', icon: 'fa-mosque' },
        'Dammam': { lat: 26.4124, lng: 50.2046, color: '#FBBF24', icon: 'fa-oil-can' }
      };
      
      var roadLayers = L.layerGroup().addTo(map);
      var markerLayers = L.layerGroup().addTo(map);
      var circleLayers = L.layerGroup().addTo(map);
      
      var cityAreas = {
        'Riyadh': [],
        'Jeddah': [],
        'Makkah': [],
        'Madinah': [],
        'Dammam': []
      };
      
      for (var areaName in trafficData) {
        var area = trafficData[areaName];
        if (cityAreas[area.city]) {
          cityAreas[area.city].push({
            name: areaName,
            nameAr: area.area_ar || '',
            lat: area.lat,
            lng: area.lng,
            status: area.status,
            color: area.traffic_color,
            description: area.description
          });
        }
      }
      
      Object.keys(cityData).forEach(function(cityName) {
        var city = cityData[cityName];
        var areas = cityAreas[cityName] || [];
        
        var pulseIcon = L.divIcon({
          html: '<div class="city-marker-pulse">' +
                  '<div class="pulse-ring" style="background: ' + city.color + ';"></div>' +
                  '<div class="pulse-dot" style="background: ' + city.color + ';"><i class="fas ' + city.icon + '" style="color: white; font-size: 20px;"></i></div>' +
                '</div>',
          iconSize: [70, 70],
          className: 'custom-city-marker'
        });
        
        var popupContent = '<div style="min-width: 280px;">' +
          '<h4 style="margin: 0 0 12px 0; color: ' + city.color + '; font-weight: 700; display: flex; align-items: center; gap: 10px; font-size: 1.1rem;">' +
            '<i class="fas ' + city.icon + '"></i>' +
            cityName +
          '</h4>' +
          '<div style="background: #F9FAFB; padding: 14px; border-radius: 10px; margin-top: 12px;">' +
            '<strong style="color: #111827; display: block; margin-bottom: 10px; font-size: 0.95rem;">Traffic Status by Area:</strong>';
        
        areas.forEach(function(area) {
          popupContent += '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding: 8px; background: white; border-radius: 6px;">' +
                           '<div style="width: 14px; height: 14px; background: ' + area.color + '; border-radius: 50%; flex-shrink: 0;"></div>' +
                           '<div style="flex: 1;">' +
                             '<div style="font-size: 0.9rem; color: #1F2937; font-weight: 600;">' + area.name + '</div>' +
                             '<div style="font-size: 0.8rem; color: #6B7280; direction: rtl;">' + area.nameAr + '</div>' +
                           '</div>' +
                           '<span style="background: ' + area.color + '; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; white-space: nowrap;">' + area.status + '</span>' +
                         '</div>';
        });
        
        popupContent += '</div></div>';
        
        var marker = L.marker([city.lat, city.lng], { icon: pulseIcon })
          .bindPopup(popupContent, { maxWidth: 320 });
        
        marker.on('mouseover', function() {
          this.openPopup();
        });
        
        markerLayers.addLayer(marker);
        
        var circle = L.circle([city.lat, city.lng], {
          color: city.color,
          fillColor: city.color,
          fillOpacity: 0.08,
          radius: 60000,
          weight: 2,
          dashArray: '10, 10',
          className: 'city-circle'
        });
        
        circleLayers.addLayer(circle);
        
        areas.forEach(function(area, index) {
          var coords = [
            [city.lat, city.lng],
            [area.lat, area.lng]
          ];
          
          var polyline = L.polyline(coords, {
            color: area.color,
            weight: 6,
            opacity: 0.8,
            smoothFactor: 1,
            className: 'traffic-road ' + area.status.toLowerCase()
          });
          
          polyline.bindPopup(
            '<div style="min-width: 260px;">' +
              '<h5 style="margin: 0 0 8px 0; color: #1F2937; font-weight: 700; font-size: 1.05rem;">' + area.name + '</h5>' +
              '<p style="margin: 0 0 10px 0; color: #6B7280; font-size: 0.9rem; direction: rtl; font-weight: 500;">' + area.nameAr + '</p>' +
              '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">' +
                '<span style="background: ' + area.color + '; color: white; padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">' + area.status + '</span>' +
                '<span style="color: #9CA3AF; font-size: 0.8rem;">' + cityName + '</span>' +
              '</div>' +
              '<p style="margin: 0; color: #4B5563; font-size: 0.9rem; line-height: 1.6; padding: 10px; background: #F9FAFB; border-radius: 8px;">' + area.description + '</p>' +
            '</div>'
          );
          
          polyline.on('mouseover', function(e) {
            this.setStyle({ weight: 10, opacity: 1 });
            this.openPopup();
          });
          
          polyline.on('mouseout', function(e) {
            this.setStyle({ weight: 6, opacity: 0.8 });
          });
          
          roadLayers.addLayer(polyline);
        });
      });
      
      var overlays = {
        '<i class="fas fa-road"></i> Traffic Roads': roadLayers,
        '<i class="fas fa-city"></i> City Markers': markerLayers,
        '<i class="far fa-circle"></i> Coverage Areas': circleLayers
      };
      
      L.control.layers(null, overlays, { position: 'topright' }).addTo(map);
      
      console.log('Smart City Map loaded with all cities and sub-areas!');
    } catch(err) {
      console.error('Error:', err);
    }
  }, 1000);
});
</script>

<style>
#map {
  height: 700px !important;
  width: 100% !important;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 12px 48px rgba(0,0,0,0.15);
  background: linear-gradient(135deg, #E0F2FE 0%, #F0F9FF 100%);
}

.map-container {
  height: 700px;
  width: 100%;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 12px 48px rgba(0,0,0,0.15);
}

.city-marker-pulse {
  position: relative;
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.pulse-ring {
  position: absolute;
  width: 70px;
  height: 70px;
  border-radius: 50%;
  animation: pulse 2s ease-out infinite;
}

.pulse-dot {
  position: relative;
  width: 55px;
  height: 55px;
  border-radius: 50%;
  border: 4px solid white;
  box-shadow: 0 6px 16px rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2;
  transition: transform 0.3s ease;
}

.pulse-dot:hover {
  transform: scale(1.15);
}

@keyframes pulse {
  0% {
    transform: scale(0.8);
    opacity: 1;
  }
  100% {
    transform: scale(2);
    opacity: 0;
  }
}

.traffic-road {
  transition: all 0.3s ease;
  cursor: pointer;
}

.traffic-road.heavy {
  animation: roadPulse 1.5s ease-in-out infinite;
}

@keyframes roadPulse {
  0%, 100% { opacity: 0.8; }
  50% { opacity: 1; }
}

.city-circle {
  transition: all 0.3s ease;
}

.leaflet-container {
  background: linear-gradient(135deg, #E0F2FE 0%, #F0F9FF 100%) !important;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.leaflet-popup-content-wrapper {
  border-radius: 12px !important;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15) !important;
}

.leaflet-popup-content {
  margin: 16px !important;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.leaflet-popup-tip {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
}

.custom-city-marker {
  background: transparent !important;
  border: none !important;
}

.leaflet-control-layers {
  border-radius: 12px !important;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15) !important;
}

.leaflet-control-zoom {
  border-radius: 12px !important;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
}

.leaflet-control-zoom a {
  width: 40px !important;
  height: 40px !important;
  line-height: 40px !important;
  font-size: 20px !important;
  transition: all 0.3s ease !important;
}

.leaflet-control-zoom a:hover {
  background: #3B82F6 !important;
  color: white !important;
}
</style>
{% endblock %}
