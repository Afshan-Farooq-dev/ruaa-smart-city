{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Ruaa Smart City - Saudi Vision 2030{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Leaflet for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v=2.0">
    <link rel="stylesheet" href="{% static 'css/animations.css' %}">
    {% block extra_css %}{% endblock %}
  </head>
  <body>
    {% block content %}{% endblock %}
    
    <!-- Dynamic AI Chatbot Floating Button -->
    {% if user.is_authenticated %}
    <div id="chatbot-container" style="position: fixed; bottom: 30px; right: 30px; z-index: 10000;">
      <!-- Chatbot Toggle Button -->
      <button id="chatbot-toggle" class="btn btn-primary" style="width: 60px; height: 60px; border-radius: 50%; box-shadow: 0 8px 24px rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: center; border: none; background: linear-gradient(135deg, #2D7A40 0%, #1a4d28 100%);" aria-label="Open AI Assistant">
        <i class="fas fa-comments" style="font-size: 1.5rem; color: white;"></i>
      </button>
      
      <!-- Chatbot Window -->
      <div id="chatbot-window" style="display: none; position: absolute; bottom: 80px; right: 0; width: 380px; max-width: 90vw; height: 500px; background: white; border-radius: 16px; box-shadow: 0 12px 48px rgba(0,0,0,0.3); overflow: hidden; flex-direction: column;">
        <!-- Header -->
        <div style="background: linear-gradient(135deg, #2D7A40 0%, #1a4d28 100%); color: white; padding: 1rem; display: flex; align-items: center; justify-content: space-between;">
          <div style="display: flex; align-items: center; gap: 0.75rem;">
            <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-robot" style="font-size: 1.25rem;"></i>
            </div>
            <div>
              <div style="font-weight: 600; font-size: 1rem;">Ruaa AI Assistant</div>
              <div style="font-size: 0.75rem; opacity: 0.9;">Powered by Groq</div>
            </div>
          </div>
          <button id="chatbot-close" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: background 0.2s;" aria-label="Close chat">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <!-- Chat Messages -->
        <div id="chatbot-messages" style="flex: 1; overflow-y: auto; padding: 1rem; background: #f8f9fa;">
          <div class="chatbot-message bot-message" style="margin-bottom: 1rem;">
            <div style="background: white; padding: 0.75rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 85%;">
              <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem; font-weight: 600;">Ruaa AI</div>
              <div style="color: #333;">ðŸ‘‹ Hello! I'm your Ruaa Smart City assistant. Ask me anything about traffic, weather, tourism, or city services!</div>
            </div>
          </div>
        </div>
        
        <!-- Input Area -->
        <div style="padding: 1rem; background: white; border-top: 1px solid #e5e7eb;">
          <form id="chatbot-form" style="display: flex; gap: 0.5rem;">
            <input type="text" id="chatbot-input" placeholder="Ask me anything..." style="flex: 1; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 24px; font-size: 0.9rem; outline: none;" required />
            <button type="submit" style="background: linear-gradient(135deg, #2D7A40 0%, #1a4d28 100%); color: white; border: none; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(45, 122, 64, 0.3);" aria-label="Send message">
              <i class="fas fa-paper-plane"></i>
            </button>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
    
    <script src="{% static 'js/app_enhanced.js' %}"></script>
    <script src="{% static 'js/ai-recommendations.js' %}"></script>
    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    {% block extra_js %}{% endblock %}
    
    <!-- Chatbot Dynamic Script -->
    {% if user.is_authenticated %}
    <script>
      (function() {
        const toggle = document.getElementById('chatbot-toggle');
        const window = document.getElementById('chatbot-window');
        const close = document.getElementById('chatbot-close');
        const form = document.getElementById('chatbot-form');
        const input = document.getElementById('chatbot-input');
        const messages = document.getElementById('chatbot-messages');
        
        let isOpen = false;
        
        function toggleChat() {
          isOpen = !isOpen;
          window.style.display = isOpen ? 'flex' : 'none';
          toggle.innerHTML = isOpen ? '<i class="fas fa-times" style="font-size: 1.5rem; color: white;"></i>' : '<i class="fas fa-comments" style="font-size: 1.5rem; color: white;"></i>';
          if (isOpen) input.focus();
        }
        
        toggle.addEventListener('click', toggleChat);
        close.addEventListener('click', toggleChat);
        
        function addMessage(text, isBot = false) {
          const msgDiv = document.createElement('div');
          msgDiv.className = 'chatbot-message ' + (isBot ? 'bot-message' : 'user-message');
          msgDiv.style.marginBottom = '1rem';
          msgDiv.style.display = 'flex';
          msgDiv.style.justifyContent = isBot ? 'flex-start' : 'flex-end';
          
          msgDiv.innerHTML = `
            <div style="background: ${isBot ? 'white' : 'linear-gradient(135deg, #2D7A40 0%, #1a4d28 100%)'}; padding: 0.75rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 85%; color: ${isBot ? '#333' : 'white'};">
              ${isBot ? '<div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem; font-weight: 600;">Ruaa AI</div>' : ''}
              <div>${text}</div>
            </div>
          `;
          messages.appendChild(msgDiv);
          messages.scrollTop = messages.scrollHeight;
        }
        
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          const message = input.value.trim();
          if (!message) return;
          
          addMessage(message, false);
          input.value = '';
          
          // Show typing indicator
          const typingDiv = document.createElement('div');
          typingDiv.id = 'typing-indicator';
          typingDiv.innerHTML = '<div style="background: white; padding: 0.75rem; border-radius: 12px; max-width: 85%;"><i class="fas fa-ellipsis-h" style="animation: pulse 1.5s infinite;"></i> Thinking...</div>';
          messages.appendChild(typingDiv);
          messages.scrollTop = messages.scrollHeight;
          
          try {
            const response = await fetch('{% url "chatbot" %}', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message: message })
            });
            const data = await response.json();
            typingDiv.remove();
            addMessage(data.response || 'Sorry, I could not process that.', true);
          } catch (error) {
            typingDiv.remove();
            addMessage('Sorry, there was an error. Please try again.', true);
          }
        });
      })();
    </script>
    {% endif %}
  </body>
</html>
